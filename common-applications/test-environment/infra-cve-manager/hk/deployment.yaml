# Deployment for icms service
---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: icms-hk
  namespace: infra-cve-manager
spec:
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: icms
  template:
    metadata:
      labels:
        app: icms
    spec:
      imagePullSecrets:
      - name: huawei-swr-image-pull-secret
      nodeSelector:
        autoscaler: "true"
      containers:
      - name: icms
        image: swr.cn-north-4.myhuaweicloud.com/opensourceway/openeuler/app-icms:17fca54fcfe6df16d8cfae7e67adffcdea0e2ca2
        resources:
          requests:
            cpu: 2000m
            memory: 2000Mi
          limits:
            cpu: 2000m
            memory: 2000Mi
        env:
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              key: db_user
              name: icms-secrets
        - name: TZ
          value: Asia/Shanghai
        - name: DB_PASS
          valueFrom:
            secretKeyRef:
              key: db_pass
              name: icms-secrets
        - name: DB_HOST
          valueFrom:
            secretKeyRef:
              key: db_host
              name: icms-secrets
        - name: DB_PORT
          valueFrom:
            secretKeyRef:
              key: db_port
              name: icms-secrets
        - name: DB_NAME
          valueFrom:
            secretKeyRef:
              key: db_name
              name: icms-secrets
        - name: SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: secret_key
              name: icms-secrets
        - name: SMTP_HOST
          valueFrom:
            secretKeyRef:
              key: smtp_host
              name: icms-secrets
        - name: SMTP_PORT
          valueFrom:
            secretKeyRef:
              key: smtp_port
              name: icms-secrets
        - name: SMTP_USERNAME
          valueFrom:
            secretKeyRef:
              key: smtp_username
              name: icms-secrets
        - name: SMTP_PASSWORD
          valueFrom:
            secretKeyRef:
              key: smtp_password
              name: icms-secrets
        - name: GITHUB_TOKEN
          valueFrom:
            secretKeyRef:
              key: github_token
              name: icms-secrets
        - name: GIT_TOKEN
          valueFrom:
            secretKeyRef:
              key: git_token
              name: icms-secrets
        - name: GIT_USERNAME
          valueFrom:
            secretKeyRef:
              key: git_username
              name: icms-secrets
        - name: GIT_PASSWORD
          valueFrom:
            secretKeyRef:
              key: git_password
              name: icms-secrets
        - name: OPS_USERNAME
          valueFrom:
            secretKeyRef:
              key: ops_username
              name: icms-secrets
        - name: OPS_PASSWORD
          valueFrom:
            secretKeyRef:
              key: ops_password
              name: icms-secrets
        volumeMounts:
        - mountPath: /work/icms/cms/migrations
          name: migrations-data
        - mountPath: /work/icms/cms/data
          name: cms-data
        command:
        - /bin/sh
        - -c
        - |
          mkdir -p cms/data/json
          mkdir -p cms/data/repo
          python manage.py collectstatic
          python manage.py makemigrations
          python manage.py migrate
          exec uwsgi --ini /work/icms/deploy/production/uwsgi.ini
      volumes:
      - name: migrations-data
        persistentVolumeClaim:
          claimName: migrations-data-volume
      - name: cms-data
        persistentVolumeClaim:
          claimName: cms-data-volume