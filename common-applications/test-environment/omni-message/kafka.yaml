apiVersion: v1
kind: Service
metadata:
  name: kafka-svc
  namespace: omni-message
  labels:
    app: kafka
spec:
  ports:
  - port: 9092
    name: server
  clusterIP: None
  selector:
    app: kafka

---
apiVersion: v1
kind: Service
metadata:
  name: kafka-0
  namespace: omni-message
  labels:
    app: kafka
spec:
  ports:
  - port: 9092
    targetPort: 9092
    nodePort: 30092
    name: server
  type: NodePort
  selector:
    statefulset.kubernetes.io/pod-name: kafka-0

---
apiVersion: v1
kind: Service
metadata:
  name: kafka-1
  namespace: omni-message
  labels:
    app: kafka
spec:
  ports:
  - port: 9092
    targetPort: 9092
    nodePort: 30093
    name: server
  type: NodePort
  selector:
    statefulset.kubernetes.io/pod-name: kafka-1

---
apiVersion: v1
kind: Service
metadata:
  name: kafka-2
  namespace: omni-message
  labels:
    app: kafka
spec:
  ports:
  - port: 9092
    targetPort: 9092
    nodePort: 30094
    name: server
  type: NodePort
  selector:
    statefulset.kubernetes.io/pod-name: kafka-2

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: kafka
  namespace: omni-message
spec:
  selector:
    matchLabels:
      app: kafka
  serviceName: kafka
  replicas: 3
  updateStrategy:
    type: RollingUpdate
  podManagementPolicy: OrderedReady
  template:
    metadata:
      labels:
        app: kafka
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: "app"
                    operator: In
                    values:
                      - kafka
              topologyKey: "kubernetes.io/hostname"
      containers:
      - name: kafka
        command:
          - bash
          - -ec
          - |
            HOSTNAME=`hostname -s`
            if [[ $HOSTNAME =~ (.*)-([0-9]+)$ ]]; then
              ORD=${BASH_REMATCH[2]}
              PORT=$((ORD + 30092))
              export KAFKA_CFG_ADVERTISED_LISTENERS="PLAINTEXT://10.0.0.173:$PORT"
            else
              echo "Failed to get index from hostname $HOST"
              exit 1
            fi
            exec /entrypoint.sh /run.sh
        image: "bitnami/kafka:2"
        env:
          - name: ALLOW_PLAINTEXT_LISTENER
            value: "yes"
          - name: KAFKA_CFG_ZOOKEEPER_CONNECT
            value: "zookeeper-0.zookeeper-hs.omni-message.svc.cluster.local:2181,zookeeper-1.zookeeper-hs.omni-message.svc.cluster.local:2181,zookeeper-2.zookeeper-hs.omni-message.svc.cluster.local:2181"
          - name: KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR
            value: "3"
          - name: KAFKA_CFG_TRANSACTION_STATE_LOG_MIN_ISR
            value: "3"
          - name: KAFKA_CFG_TRANSACTION_STATE_LOG_REPLICATION_FACTOR
            value: "3"
        ports:
          - containerPort: 9092
        volumeMounts:
          - name: kafka-data
            mountPath: /bitnami
      securityContext:
        runAsUser: 1000
        fsGroup: 1000
      volumes:
      - name: kafka-data
        persistentVolumeClaim:
          claimName: cce-sfs-kafka
