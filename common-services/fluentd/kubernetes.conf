# AUTOMATICALLY GENERATED
# DO NOT EDIT THIS FILE DIRECTLY, USE /templates/conf/kubernetes.conf.erb

<label @FLUENT_LOG>
        <match fluent.**>
                @type null
        </match>
</label>

<source>
        @type tail
        @id in_tail_container_logs
        path /var/log/containers/*.log
        pos_file /var/log/fluentd-containers.log.pos
        tag "#{ENV['FLUENT_CONTAINER_TAIL_TAG'] || 'kubernetes.*'}"
        exclude_path "#{ENV['FLUENT_CONTAINER_TAIL_EXCLUDE_PATH'] || use_default}"
        read_from_head true
        <parse>
                @type "#{ENV['FLUENT_CONTAINER_TAIL_PARSER_TYPE'] || 'json'}"
                time_format %Y-%m-%dT%H:%M:%S.%NZ
        </parse>
</source>

<source>
        @type tail
        @id in_tail_docker
        path /var/log/docker.log
        pos_file /var/log/fluentd-docker.log.pos
        tag docker
        <parse>
                @type regexp
                expression /^time="(?<time>[^)]*)" level=(?<severity>[^ ]*) msg="(?<message>[^"]*)"( err="(?<error>[^"]*)")?( statusCode=($<status_code>\d+))?/
        </parse>
</source>

<source>
        @type tail
        @id in_tail_kubelet
        multiline_flush_interval 5s
        path /var/paas/sys/log/kubernetes/kubelet.log
        pos_file /var/log/fluentd-kubelet.log.pos
        tag kubelet
        <parse>
                @type kubernetes
        </parse>
</source>

<source>
        @type tail
        @id in_tail_kube_proxy
        multiline_flush_interval 5s
        path /var/paas/sys/log/kubernetes/kube-proxy.log
        pos_file /var/log/fluentd-kube-proxy.log.pos
        tag kube-proxy
        <parse>
                @type kubernetes
        </parse>
</source>

<source>
        @type tail
        @id in_tail_everest_driver
        multiline_flush_interval 5s
        path /var/paas/sys/log/everest-csi-driver/everest-csi-driver-standalone.log
        pos_file /var/log/everest-csi-driver.log.pos
        tag everest
        <parse>
                @type kubernetes
        </parse>
</source>

<source>
        @type tail
        @id in_tail_everest_driver_connector
        multiline_flush_interval 5s
        path /var/paas/sys/log/everest-csi-driver/everest-host-connector.log
        pos_file /var/log/everest-csi-driver-connector.log.pos
        tag everest
        <parse>
                @type kubernetes
        </parse>
</source>

<source>
        @type tail
        @id in_tail_fuxi
        multiline_flush_interval 5s
        path /var/paas/sys/log/fuxi.log
        pos_file /var/log/fuxi.log.pos
        tag everest
        <parse>
        @type kubernetes
        </parse>
</source>


<source>
        @type tail
        @id in_tail_fuxi_efs
        multiline_flush_interval 5s
        path /var/paas/sys/log/fuxi-efs.log
        pos_file /var/log/fuxi-efs.log.pos
        tag everest
        <parse>
        @type kubernetes
        </parse>
</source>

<source>
        @type tail
        @id in_tail_fuxi_nfs
                multiline_flush_interval 5s
                path /var/paas/sys/log/fuxi-nfs.log
        pos_file /var/log/fuxi-nfs.log.pos
        tag everest
        <parse>
        @type kubernetes
        </parse>
</source>

<source>
        @type tail
        @id in_tail_fuxi_obs
        multiline_flush_interval 5s
        path /var/paas/sys/log/fuxi-obs.log
        pos_file /var/log/fuxi-obs.log.pos
        tag everest
        <parse>
                @type kubernetes
        </parse>
</source>

<filter kubernetes.**>
        @type kubernetes_metadata
        @id filter_kube_metadata
        kubernetes_url "#{ENV['FLUENT_FILTER_KUBERNETES_URL'] || 'https://' + ENV.fetch('KUBERNETES_SERVICE_HOST') + ':' + ENV.fetch('KUBERNETES_SERVICE_PORT') + '/api'}"
        verify_ssl "#{ENV['KUBERNETES_VERIFY_SSL'] || true}"
        ca_file "#{ENV['KUBERNETES_CA_FILE']}"
</filter>
<filter kubernetes.**>
        @type parser
        key_name log
        <parse>
                @type json
                json_parser json
        </parse>
        replace_invalid_sequence true
        reserve_data true # this preserves unparsable log lines
        emit_invalid_record_to_error false # In case of unparsable log lines keep the error log clean
        reserve_time true # the time was already parsed in the source, we don't want to overwrite it with current time.
</filter>
